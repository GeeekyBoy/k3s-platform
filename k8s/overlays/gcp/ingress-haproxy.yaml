# HAProxy Ingress with KEDA HTTP Add-on Integration
# Routes traffic: HAProxy -> KEDA Interceptor -> App (with cold-start buffering)
#
# Architecture:
#   GCP Network LB (single IP) -> HAProxy Ingress -> KEDA Interceptor -> Apps
#
# Benefits:
#   - Single Load Balancer (~$18/month instead of $18 per app)
#   - Path-based routing via KEDA HTTPScaledObjects (pathPrefixes)
#   - Zero request drops during cold starts (KEDA buffers requests)
#   - Retry policies for reliability
#
# IMPORTANT: HAProxy Ingress resources for serverless functions are now
# AUTO-GENERATED by the k3sfn CLI tool. Do NOT manually add routes here.
#
# To add/update serverless function routes:
#   1. Define functions in apps/<app-name>/functions/*.py with decorators
#   2. Run: k3sfn generate apps/<app-name> --name <app-name> --ingress haproxy
#   3. Apply generated manifests from argocd-state/gcp/serverless/<app-name>/
#
# The CLI generates per-function ExternalName services that resolve to
# KEDA interceptor via DNS (no hardcoded IPs), preventing HAProxy from
# merging backends and allowing per-path Host header rewriting.
#
# Only FastAPI (non-serverless) resources are defined here:
---
# KEDA HTTPScaledObject for FastAPI
# Uses host-based routing with host header from HAProxy
apiVersion: http.keda.sh/v1alpha1
kind: HTTPScaledObject
metadata:
  name: fastapi-http
  namespace: apps
spec:
  hosts:
    - fastapi.apps
  pathPrefixes:
    - /
  scaleTargetRef:
    name: fastapi
    kind: Deployment
    apiVersion: apps/v1
    service: fastapi
    port: 8000
  replicas:
    min: 0
    max: 10
  scalingMetric:
    requestRate:
      granularity: 1s
      targetValue: 100
      window: 1m
  scaledownPeriod: 300
---
# Per-route ExternalName service for FastAPI -> KEDA interceptor
apiVersion: v1
kind: Service
metadata:
  name: keda-route-fastapi
  namespace: apps
  labels:
    k3sfn.io/component: keda-route
spec:
  type: ExternalName
  externalName: keda-add-ons-http-interceptor-proxy.keda.svc.cluster.local
  ports:
    - port: 8080
      targetPort: 8080
      protocol: TCP
---
# HAProxy Ingress for /fastapi -> fastapi
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: fastapi-haproxy
  namespace: apps
  labels:
    k3sfn.io/ingress: haproxy
  annotations:
    haproxy-ingress.github.io/timeout-connect: "10s"
    haproxy-ingress.github.io/timeout-server: "180s"
    haproxy-ingress.github.io/timeout-client: "180s"
    haproxy-ingress.github.io/timeout-queue: "180s"
    haproxy-ingress.github.io/retry-on: "conn-failure,empty-response,response-timeout"
    haproxy-ingress.github.io/retries: "3"
    # Rewrite Host header for KEDA routing and strip /fastapi prefix
    # HAProxy config-backend uses HAProxy directives to manipulate request
    # 1. Set Host header for KEDA interceptor routing
    # 2. Use regsub to strip /fastapi prefix from path (e.g., /fastapi/health -> /health)
    haproxy-ingress.github.io/config-backend: |
      http-request set-header Host fastapi.apps
      http-request set-path %[path,regsub(^/fastapi/,/),regsub(^/fastapi$,/)]
spec:
  ingressClassName: haproxy
  rules:
    - http:
        paths:
          - path: /fastapi
            pathType: Prefix
            backend:
              service:
                name: keda-route-fastapi
                port:
                  number: 8080
