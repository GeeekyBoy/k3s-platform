apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
  - ../../base
  # HAProxy Ingress with KEDA HTTP Add-on (single LB, path routing, zero request drops)
  - ingress-haproxy.yaml
  # Legacy: scaledobject.yaml for queue-based scaling (if needed alongside HTTP scaling)
  # - scaledobject.yaml

# Image transformer for GCP Artifact Registry
images:
  - name: fastapi-app
    newName: us-central1-docker.pkg.dev/bloompath-canary/k3s-platform/fastapi
    newTag: latest

transformers:
  - |-
    apiVersion: builtin
    kind: NamespaceTransformer
    metadata:
      name: namespace-transformer
    namespace: apps
    unsetOnly: true

patches:
  - patch: |-
      - op: add
        path: /spec/template/spec/imagePullSecrets
        value:
          - name: artifact-registry
    target:
      kind: Deployment
      name: fastapi
  - patch: |-
      $patch: delete
      apiVersion: autoscaling/v2
      kind: HorizontalPodAutoscaler
      metadata:
        name: fastapi
    target:
      kind: HorizontalPodAutoscaler
      name: fastapi

labels:
  - pairs:
      environment: gcp
      cloud: gcp
    includeSelectors: false

configMapGenerator:
  - name: fastapi-config
    literals:
      - ENV=production
      - LOG_LEVEL=INFO