# K3s Platform - Application Configuration v2
# ==============================================================================
# This file is the single source of truth for all deployments.
#
# Environments:
#   - dev:   Local development with Tilt hot-reload
#   - local: On-premises production-like deployment (k3d + ArgoCD)
#   - gcp:   Cloud production deployment (GCP + ArgoCD)
#
# Deployment Types:
#   - helm:       Third-party Helm charts (databases, etc.)
#   - serverless: k3sfn functions with scale-to-zero
#   - apps:       Traditional container applications (k3sapp)
#   - compose:    Docker Compose projects (k3scompose)
#
# To add/remove services, just enable/disable entries below.
# No script or Tiltfile changes needed!
# ==============================================================================

version: "2"

# Global defaults applied across all environments
defaults:
  namespace: apps
  registry:
    local: ""
    dev: ""
    gcp: "us-central1-docker.pkg.dev/${PROJECT_ID}/k3s-platform"
  ingress:
    local: traefik
    dev: traefik
    gcp: haproxy

# Environment-specific global settings
environments:
  local:
    domain: "localhost"
    tls: false
  dev:
    domain: "localhost"
    tls: false
  gcp:
    domain: "${GCP_DOMAIN}"
    tls: true
    tls_secret: "letsencrypt-prod"

# Helm Charts (third-party services)
helm:
  - name: valkey
    chart: bitnami/valkey
    version: "5.0.10"
    namespace: apps
    values: apps/valkey/values.yaml
    enabled: true

# Serverless Functions (k3sfn with @http, @queue, @schedule decorators)
# Functions are discovered automatically, built, and deployed with scale-to-zero
serverless:
  - name: serverless-example
    path: apps/serverless-example
    namespace: apps
    enabled: true
    security:
      visibility: public
    local:
      port_base: 8081
    dev:
      port_base: 8081
      live_update: true

# Traditional Container Apps (k3sapp - Dockerfile-based)
apps:
  - name: fastapi
    path: apps/fastapi
    namespace: apps
    enabled: true
    build:
      dockerfile: Dockerfile
      dockerfile_dev: Dockerfile.dev
    container:
      ports:
        - name: http
          container_port: 8000
          service_port: 80
    resources:
      memory: "256Mi"
      cpu: "100m"
      memory_limit: "512Mi"
    scaling:
      type: keda-http
      min_instances: 0
      max_instances: 10
      target_pending_requests: 100
    probes:
      startup:
        type: http
        path: /health
        port: 8000
        failure_threshold: 30
      readiness:
        type: http
        path: /health
        port: 8000
      liveness:
        type: http
        path: /health
        port: 8000
    ingress:
      enabled: true
      path: /fastapi
      strip_prefix: true
    security:
      visibility: public
      network_policy:
        enabled: true
    local:
      scaling:
        type: none
      replicas: 1
    dev:
      port: 8000
      live_update: true
      sync:
        - src: src/
          dest: /app/src/
    gcp:
      pod_disruption_budget:
        min_available: 1

# Docker Compose Projects (k3scompose)
compose:
  - name: postgresql
    path: apps/postgresql
    compose_file: docker-compose.yaml
    namespace: apps
    enabled: true
    services:
      postgres:
        resources:
          memory: "256Mi"
          cpu: "100m"
          memory_limit: "512Mi"
        volumes:
          - name: postgres-data
            type: pvc
            size: 1Gi
            storage_class: standard
            mount_path: /var/lib/postgresql/data

# Helm Repository URLs
repositories:
  bitnami: oci://registry-1.docker.io/bitnamicharts
  kedacore: https://kedacore.github.io/charts
